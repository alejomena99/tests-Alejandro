trigger: none

variables:
  - group: alejo-var-infra

  - name: sshPub
    value: $(sshPub.secureFilePath)

  - name: sshPriv
    value: $(sshPriv.secureFilePath)

stages:
- stage: stage
  displayName: stage
  jobs:
  - job: 'job'
    pool:
      vmImage: ubuntu-latest

    steps:

    # - task: DownloadSecureFile@1
    #   displayName: 'VM ssh file download'
    #   name: sshPub
    #   inputs:
    #     secureFile: 'alejo-ssh.pub'


    - task: DownloadSecureFile@1
      displayName: 'VM ssh file download'
      name: sshPriv
      inputs:
        secureFile: 'alejo_id_rsa'

    # - task: replacetokens@3
    #   displayName: 'Replace Tokens for bash scripts'
    #   inputs:
    #     targetFiles: |
    #       scripts/*.sh

    # - task: Bash@3
    #   inputs:
    #     filePath: 'scripts/az-infra.sh'
    
    # - task: replacetokens@3
    #   displayName: 'Replace Tokens for terraform scripts'
    #   inputs:
    #     targetFiles: |
    #       terraform/*.tf

    # - task: TerraformInstaller@1
    #   displayName: 'Install or Update Terraform'
    #   inputs:
    #     terraformVersion: 1.0.7
    
    # - script: |
    #     terraform init
    #   displayName: 'terraform init'
    #   workingDirectory: 'terraform/'

    # - script: |
    #     terraform plan
    #   displayName: 'terraform plan'
    #   workingDirectory: 'terraform/'

    # - script: |
    #     terraform apply -auto-approve
    #   displayName: 'terraform apply'
    #   workingDirectory: 'terraform/'

    # - script: |
    #     az login --service-principal -u $(CLIENT_ID) -p $(CLIENT_SECRET) --tenant $(TENANT_ID)
    #     vm_name=$(az vm list --resource-group $(RESOURCE_GROUP) | jq -r '.[].name')
    #     az vm show -g $(RESOURCE_GROUP) -n $vm_name -d --query publicIps -o tsv
    #   displayName: 'Show public IP'

    # - task: replacetokens@3
    #   displayName: 'Replace Tokens for ansible scripts'
    #   inputs:
    #     targetFiles: |clear
    #       ansible/*.ini

    - task: InstallSSHKey@0
      displayName: 'Install an SSH key'
      inputs:
        knownHostsEntry: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDUQnggYiOUMkerhr7TcShgpik0gklR9/1BAYIM4iBsgUEqZPOalqsVgztU2GmW91FtDqjMwGXqcVU7Y+E7V64gL1KK8Rxpe/BvxiQNilOLrqmTYWkwiY04iCyV/VAqVqzoM4OxvPe2MjG2suRqz9KfKj3UqhgD+i6rxLK9i8o1oAVCnCXrMWFxWAi4G3IQyP70L6rEyL6n/PnK7+ayyl0PXGj5nHt9kApdrYA7kPjzvV5FOFfDJTgzE6iRHUDaYD6KbCXOffxrLk4H2RqZgxSTdjegFJGfP4NT3NBfumAus9/ss9FYGNNjz5eE+R2+Vt5+TZVvg2YggMkWT4P1DraNfa1E4qTN3G7JF/o5rIYSe40cdG4b3SszEjpMHua6TxS8F2ocjn/F9wUy1HetPrn58FpE0hWVeeyh2eF4zeaQqlr1xxrUPG/ugcyLsJXDXehLQQq8ydjT5snL3ZtTscWC7temL8GMD6kUPQFfVjBr+w7abqvUsSG8RZU81xnsWWXnyHP5kfvmDuaRGuiUj3NC9J0xjhba6A1NQ9AuT5TsvTUacb5rZZPFuLzvyaQKkTgdhDT7Yi7NuWg68QsWDcrGYzc/p1SNTvA1h7p0HYSMQ7RTsCrxH0qEcT14qE18ua3otdwoADTgv8KTBjBljpWCpVVTXCVNQEYpDzAKsaDy9w== manuel.mena@quind.io'
        sshKeySecureFile: 'alejo_id_rsa'

    - script: ssh -n adminuser@52.179.166.17

